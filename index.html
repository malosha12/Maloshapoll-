<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mfumo wa Kupiga Kura</title>
    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #007BFF;
            --secondary-color: #2C3E50;
            --background-color: #F4F7FA;
            --border-color: #DDE4E9;
            --hover-color: #E9F1FF;
            --text-color: #2C3E50;
            --text-secondary: #7F8C8D;
            --danger-color: #E74C3C;
            --success-color: #27AE60;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
            box-sizing: border-box;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .poll-header {
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .poll-title {
            font-size: 22px;
            font-weight: 600;
            margin: 0;
            flex-grow: 1;
        }

        .time-remaining {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .poll-info {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        .poll-options {
            margin-bottom: 20px;
        }

        .poll-option {
            border: 1px solid var(--border-color);
            border-radius: 30px;
            padding: 15px 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
        }

        .poll-option:hover {
            background-color: var(--hover-color);
            transform: translateX(5px);
        }

        .poll-option.selected {
            border-color: var(--primary-color);
            background-color: var(--hover-color);
        }

        .poll-option.disabled {
            cursor: default;
        }

        .poll-option-text {
            font-size: 16px;
            flex-grow: 1;
        }

        .poll-result {
            display: none;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 5px;
            margin-top: 10px;
            width: 0;
            transition: width 1s ease-in-out;
        }

        .poll-percentage {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: right;
            display: none;
            margin-top: 5px;
        }

        .vote-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .vote-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        .vote-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        .results-info {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .total-votes {
            display: none;
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 20px;
            text-align: center;
        }

        .error-message {
            color: var(--danger-color);
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        .style-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }

        .toggle-btn {
            background-color: var(--border-color);
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-btn:first-child {
            border-radius: 20px 0 0 20px;
        }

        .toggle-btn:last-child {
            border-radius: 0 20px 20px 0;
        }

        .toggle-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .whatsapp-theme {
            --primary-color: #00C4B4;
            --secondary-color: #1A3C34;
            --background-color: #F0F2F5;
            --border-color: #DDE4E9;
            --hover-color: #E6ECEF;
        }

        .create-poll-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            display: block;
        }

        .create-poll-btn:hover {
            background-color: #1A3C34;
            transform: scale(1.05);
        }

        .create-poll-form, .edit-poll-form {
            display: none;
            margin-top: 20px;
            animation: slideIn 0.5s ease-in-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .option-input-container {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .option-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .option-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .remove-option-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-option-btn:hover {
            background-color: #C0392B;
            transform: scale(1.1);
        }

        .add-option-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-option-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        .submit-poll-btn, .update-poll-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .submit-poll-btn:hover, .update-poll-btn:hover {
            background-color: #219653;
            transform: scale(1.05);
        }

        .admin-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
            display: none;
        }

        .admin-poll-card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .admin-poll-card div {
            margin-bottom: 10px;
        }

        .admin-poll-card strong {
            color: var(--primary-color);
        }

        .options-list {
            margin-left: 20px;
        }

        .options-list div {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .delete-btn, .edit-btn, .back-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .edit-btn {
            background-color: var(--primary-color);
        }

        .delete-btn:hover, .edit-btn:hover, .back-btn:hover {
            transform: scale(1.05);
        }

        .delete-btn:hover {
            background-color: #C0392B;
        }

        .edit-btn:hover {
            background-color: #0056b3;
        }

        .icon {
            margin-right: 10px;
            font-size: 18px;
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-in-out;
        }

        .password-modal-content {
            background: linear-gradient(135deg, #ffffff, #f0f4ff);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            text-align: center;
            animation: slideUp 0.5s ease-in-out;
            position: relative;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .password-modal-content h2 {
            margin: 0 0 25px;
            font-size: 26px;
            color: var(--primary-color);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .password-modal-content input {
            width: 100%;
            padding: 15px;
            margin-bottom: 25px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }

        .password-modal-content input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
            outline: none;
        }

        .password-modal-content button {
            background: linear-gradient(90deg, var(--primary-color), #0056b3);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .password-modal-content button:hover {
            background: linear-gradient(90deg, #0056b3, var(--primary-color));
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
        }

        .time-expired {
            color: var(--danger-color);
            font-weight: bold;
        }

        body.dark-mode {
            --background-color: #1A1A1A;
            --text-color: #FFFFFF;
            --border-color: #444;
            --hover-color: #333;
        }

        body.dark-mode .container {
            background-color: #2D2D2D;
        }

        body.dark-mode .admin-section {
            background-color: #2D2D2D;
        }

        body.dark-mode .password-modal-content {
            background: linear-gradient(135deg, #2D2D2D, #444);
        }

        .mode-toggle {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .mode-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="style-toggle">
            <button class="toggle-btn active" data-theme="twitter">OLD STYLE     </button>
            <button class="toggle-btn" data-theme="whatsapp">MORDEN STYLE   </button>
        </div>

        <button class="create-poll-btn"><span class="icon">‚úçÔ∏è</span>malosha use only</button>
        
        <div class="create-poll-form">
            <div class="form-group">
                <label class="form-label" for="poll-title"><span class="icon">‚ùì</span>Swali la Kura:</label>
                <input type="text" id="poll-title" class="form-input" placeholder="Andika swali lako hapa...">
            </div>
            <div class="form-group">
                <label class="form-label"><span class="icon">‚úÖ</span>Chaguo:</label>
                <div id="options-container">
                    <div class="option-input-container">
                        <input type="text" class="option-input" placeholder="Chaguo 1">
                        <button class="remove-option-btn">‚úï</button>
                    </div>
                    <div class="option-input-container">
                        <input type="text" class="option-input" placeholder="Chaguo 2">
                        <button class="remove-option-btn">‚úï</button>
                    </div>
                </div>
                <button class="add-option-btn"><span class="icon">‚ûï</span>Ongeza Chaguo</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="poll-duration"><span class="icon">‚è≥</span>Muda wa Kura:</label>
                <input type="number" id="poll-duration" class="form-input" min="1" placeholder="Weka muda wa mwisho wa upigaji kura">
                <select id="duration-unit" class="form-select">          
                    <option value="seconds">Sekunde</option>
                    <option value="minutes">Dakika</option>
                    <option value="hours">Saa</option>
                    <option value="weeks">Wiki</option>
                    <option value="months">Mwezi</option>
                    <option value="years">Mwaka</option>
                </select>
            </div>
            <button class="submit-poll-btn"><span class="icon">üöÄ</span>Tengeneza Kura</button>
        </div>

        <div class="edit-poll-form">
            <div class="form-group">
                <label class="form-label" for="edit-poll-title"><span class="icon">‚ùì</span>Swali la Kura:</label>
                <input type="text" id="edit-poll-title" class="form-input" placeholder="Andika swali lako hapa...">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-poll-duration"><span class="icon">‚è≥</span>Muda wa Kura:</label>
                <input type="number" id="edit-poll-duration" class="form-input" min="1" placeholder="Weka muda wa mwisho">
                <select id="edit-duration-unit" class="form-select">
                    <option value="seconds">Sekunde</option>
                    <option value="minutes">Dakika</option>
                    <option value="hours">Saa</option>
                    <option value="weeks">Wiki</option>
                    <option value="months">Mwezi</option>
                    <option value="years">Mwaka</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label"><span class="icon">‚úÖ</span>Chaguo:</label>
                <div id="edit-options-container"></div>
                <button class="add-option-btn"><span class="icon">‚ûï</span>Ongeza Chaguo</button>
            </div>
            <button class="update-poll-btn"><span class="icon">üîÑ</span>Rekebisha Kura</button>
        </div>

        <div id="active-poll">
            <div class="poll-header">
                <div>
                    <div class="poll-title"></div>
                    <div class="time-remaining"></div>
                </div>
                <span class="icon">üïí</span>
            </div>
            <div class="poll-info">
                <span class="poll-author"></span>
                <span class="poll-date"></span>
            </div>
            <div class="poll-options" id="poll-options"></div>
            <button id="vote-btn" class="vote-btn" disabled><span class="icon">üó≥Ô∏è</span>Piga Kura</button>
            <div id="error-message" class="error-message"></div>
            <div class="results-info">Matokeo yataonekana baada ya kupiga kura</div>
            <div class="total-votes">Jumla ya kura: <span id="votes-count">0</span></div>
        </div>

        <div class="admin-section" id="admin-section">
            <h2><span class="icon">üë§</span>Admin Panel</h2>
            <button class="back-btn" id="back-btn"><span class="icon">‚¨ÖÔ∏è</span>Rudi Nyuma</button>
            <div id="admin-polls-list"></div>
            <h3><span class="icon">üìú</span>Historia ya Kura</h3>
            <div id="admin-history-list"></div>
        </div>

        <div class="mode-toggle">
            <button class="mode-btn" id="light-mode">Light Mode</button>
            <button class="mode-btn" id="dark-mode">Dark Mode</button>
        </div>
    </div>

    <div class="password-modal" id="password-modal">
        <div class="password-modal-content">
            <h2><span class="icon">üîí</span>TRY ANY PASSWORD</h2>
            <input type="password" id="password-input" placeholder="Nenosiri">
            <button id="password-submit"><span class="icon">‚úÖ</span>Thibitisha</button>
        </div>
    </div>

    <script>
        // Firebase Config with corrected databaseURL
        const firebaseConfig = {
            apiKey: "AIzaSyBxibHHgfBunsCVowPCKWDIV2K3kG9OviE",
            authDomain: "x-poll-6dc62.firebaseapp.com",
            databaseURL: "https://x-poll-6dc62-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "x-poll-6dc62",
            storageBucket: "x-poll-6dc62.firebasestorage.app",
            messagingSenderId: "463476174133",
            appId: "1:463476174133:web:9c68ee0f855b6e0c28b07c",
            measurementId: "G-T5N05Z0ETF"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const defaultPoll = {
            id: 'default-poll',
            title: 'Muda wa kura unaweza kuisha lini?',
            author: 'maloshadavid@92gmail.com',
            date: new Date().toLocaleDateString('sw'),
            options: [
                { id: 1, text: 'Saa 1', votes: 0 },
                { id: 2, text: 'Saa 2', votes: 0 }
            ],
            totalVotes: 0,
            duration: 5,
            durationUnit: 'minutes',
            endTime: null,
            isExpired: false
        };

        // Wait for DOM to load before accessing elements
        document.addEventListener('DOMContentLoaded', () => {
            const pollOptionsEl = document.getElementById('poll-options');
            const voteBtn = document.getElementById('vote-btn');
            const errorMessage = document.getElementById('error-message');
            const resultsInfo = document.querySelector('.results-info');
            const totalVotesEl = document.querySelector('.total-votes');
            const votesCountEl = document.getElementById('votes-count');
            const timeRemainingEl = document.querySelector('.time-remaining');
            const themeToggleBtns = document.querySelectorAll('.toggle-btn');
            const createPollBtn = document.querySelector('.create-poll-btn');
            const createPollForm = document.querySelector('.create-poll-form');
            const editPollForm = document.querySelector('.edit-poll-form');
            const activePollEl = document.getElementById('active-poll');
            const adminSection = document.getElementById('admin-section');
            const adminPollsList = document.getElementById('admin-polls-list');
            const adminHistoryList = document.getElementById('admin-history-list');
            const passwordModal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const passwordSubmit = document.getElementById('password-submit');
            const backBtn = document.getElementById('back-btn');
            const lightModeBtn = document.getElementById('light-mode');
            const darkModeBtn = document.getElementById('dark-mode');

            let selectedOption = null;
            let currentPoll = null;
            let allPolls = [];
            let pollHistory = [];
            let hasVoted = false;
            let isAdmin = false;
            const CREATE_POLL_PASSWORD = "1340";

            function init() {
                loadPollsFromFirebase();
                loadHistoryFromFirebase();
                setupEventListeners();
                checkPollExpiration();
                updateTimeRemaining();
            }

            function loadPollsFromFirebase() {
                db.ref('polls').once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        allPolls = Object.values(data);
                        if (allPolls.length > 0) {
                            currentPoll = allPolls[0]; // Load the first poll as active
                            renderPoll();
                        }
                    } else {
                        allPolls = [defaultPoll];
                        allPolls[0].endTime = new Date().getTime() + defaultPoll.duration * 60000;
                        currentPoll = allPolls[0];
                        savePollsToFirebase();
                        renderPoll();
                    }
                });
            }

            function loadHistoryFromFirebase() {
                db.ref('history').once('value', (snapshot) => {
                    const data = snapshot.val();
                    pollHistory = data ? Object.values(data) : [];
                    if (isAdmin && adminHistoryList) updateAdminPanel();
                });
            }

            function savePollsToFirebase() {
                db.ref('polls').set(allPolls);
            }

            function saveHistoryToFirebase() {
                db.ref('history').set(pollHistory);
            }

            function saveVoteToFirebase(pollId) {
                getVotedPollsFromFirebase((votedPolls) => {
                    if (!votedPolls.includes(pollId)) {
                        votedPolls.push(pollId);
                        db.ref('votedPolls').set(votedPolls);
                    }
                });
            }

            function getVotedPollsFromFirebase(callback) {
                db.ref('votedPolls').once('value', (snapshot) => {
                    const data = snapshot.val();
                    callback(data ? (Array.isArray(data) ? data : []) : []);
                });
            }

            function renderPoll() {
                if (!currentPoll || !activePollEl) return;
                document.querySelector('.poll-title').textContent = currentPoll.title || '';
                document.querySelector('.poll-author').textContent = currentPoll.author || '';
                document.querySelector('.poll-date').textContent = currentPoll.date || '';

                if (pollOptionsEl) pollOptionsEl.innerHTML = '';
                (currentPoll.options || []).forEach(option => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'poll-option';
                    optionEl.dataset.option = option.id;
                    optionEl.innerHTML = `
                        <div class="poll-option-text">${option.text}</div>
                        <div class="poll-result"></div>
                        <div class="poll-percentage">0%</div>
                    `;
                    if (pollOptionsEl) pollOptionsEl.appendChild(optionEl);
                });

                selectedOption = null;
                if (voteBtn) voteBtn.disabled = true;
                if (errorMessage) errorMessage.style.display = 'none';
                if (resultsInfo) resultsInfo.style.display = 'block';
                if (totalVotesEl) totalVotesEl.style.display = 'none';
                if (votesCountEl) votesCountEl.textContent = currentPoll.totalVotes || 0;

                document.querySelectorAll('.poll-option').forEach(option => {
                    option.addEventListener('click', selectOption);
                });

                if (activePollEl) activePollEl.style.display = 'block';
                checkIfUserVoted();
            }

            function checkIfUserVoted() {
                if (!currentPoll) return;
                getVotedPollsFromFirebase((votedPolls) => {
                    hasVoted = votedPolls.includes(currentPoll.id);
                    if (hasVoted || currentPoll.isExpired) {
                        showResults();
                        if (voteBtn) voteBtn.disabled = true;
                    } else {
                        hideResults();
                    }
                });
            }

            function selectOption() {
                if (hasVoted || (currentPoll && currentPoll.isExpired)) return;

                document.querySelectorAll('.poll-option').forEach(option => {
                    option.classList.remove('selected');
                });

                this.classList.add('selected');
                selectedOption = parseInt(this.dataset.option);
                if (voteBtn) voteBtn.disabled = false;
            }

            function submitVote() {
                if (!selectedOption || !currentPoll) {
                    if (errorMessage) {
                        errorMessage.textContent = 'Tafadhali chagua chaguo moja';
                        errorMessage.style.display = 'block';
                    }
                    return;
                }

                const option = currentPoll.options.find(o => o.id === selectedOption);
                if (option) {
                    option.votes++;
                    currentPoll.totalVotes++;

                    const pollIndex = allPolls.findIndex(p => p && p.id === currentPoll.id);
                    if (pollIndex !== -1) {
                        allPolls[pollIndex] = currentPoll;
                        savePollsToFirebase();
                    }

                    saveVoteToFirebase(currentPoll.id);
                    hasVoted = true;
                    showResults();
                }
            }

            function showResults() {
                if (!currentPoll) return;
                document.querySelectorAll('.poll-option').forEach(option => {
                    option.classList.add('disabled');
                    option.removeEventListener('click', selectOption);
                });

                if (voteBtn) voteBtn.disabled = true;

                const totalVotes = currentPoll.totalVotes || 0;
                document.querySelectorAll('.poll-option').forEach(optionEl => {
                    const optionId = parseInt(optionEl.dataset.option);
                    const option = (currentPoll.options || []).find(o => o.id === optionId);
                    
                    if (option) {
                        const percentage = totalVotes > 0 ? (option.votes / totalVotes) * 100 : 0;
                        const roundedPercentage = Math.round(percentage);
                        
                        const resultEl = optionEl.querySelector('.poll-result');
                        const percentageEl = optionEl.querySelector('.poll-percentage');
                        
                        if (resultEl) {
                            resultEl.style.display = 'block';
                            setTimeout(() => {
                                resultEl.style.width = `${percentage}%`;
                            }, 50);
                        }
                        if (percentageEl) percentageEl.style.display = 'block';
                        if (percentageEl) percentageEl.textContent = `${roundedPercentage}%`;

                        if (optionId === selectedOption) {
                            optionEl.classList.add('selected');
                        }
                    }
                });

                if (totalVotesEl) totalVotesEl.style.display = 'block';
                if (votesCountEl) votesCountEl.textContent = totalVotes;
                if (resultsInfo) resultsInfo.style.display = 'none';
                if (errorMessage) errorMessage.style.display = 'none';
            }

            function hideResults() {
                document.querySelectorAll('.poll-option').forEach(option => {
                    option.classList.remove('disabled');
                    const resultEl = option.querySelector('.poll-result');
                    const percentageEl = option.querySelector('.poll-percentage');
                    if (resultEl) {
                        resultEl.style.display = 'none';
                        resultEl.style.width = '0';
                    }
                    if (percentageEl) percentageEl.style.display = 'none';
                });

                if (resultsInfo) resultsInfo.style.display = 'block';
                if (totalVotesEl) totalVotesEl.style.display = 'none';
            }

            function toggleTheme(theme) {
                const container = document.querySelector('.container');
                if (container) {
                    if (theme === 'whatsapp') {
                        container.classList.add('whatsapp-theme');
                    } else {
                        container.classList.remove('whatsapp-theme');
                    }
                }
                if (createPollBtn) createPollBtn.style.display = 'block';
            }

            function formatTimeRemaining(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                const weeks = Math.floor(days / 7);
                const months = Math.floor(days / 30);
                const years = Math.floor(days / 365);
                if (years > 0) return `${years} mwaka${years > 1 ? 's' : ''}`;
                if (months > 0) return `${months} mwezi${months > 1 ? 's' : ''}`;
                if (weeks > 0) return `${weeks} wiki${weeks > 1 ? 's' : ''}`;
                if (days > 0) return `${days} siku${days > 1 ? 's' : ''}`;
                if (hours > 0) return `${hours} saa${hours > 1 ? 's' : ''}`;
                if (minutes > 0) return `${minutes} dakika${minutes > 1 ? 's' : ''}`;
                return `${seconds} sekunde${seconds > 1 ? 's' : ''}`;
            }
            
            function updateTimeRemaining() {
                setInterval(() => {
                    if (!currentPoll || !currentPoll.endTime || !timeRemainingEl) return;
                    const now = new Date().getTime();
                    const timeLeft = currentPoll.endTime - now;
                    if (timeLeft > 0) {
                        timeRemainingEl.textContent = `Muda uliobaki: ${formatTimeRemaining(timeLeft)}`;
                        timeRemainingEl.classList.remove('time-expired');
                    } else {
                  timeRemainingEl.textContent = ' Muda wa kupiga kura umekwisha';
                        timeRemainingEl.classList.add('time-expired');
                        currentPoll.isExpired = true;
                    }
                }, 1000);
            }

            function checkPollExpiration() {
                setInterval(() => {
                    const now = new Date().getTime();
                    allPolls.forEach(poll => {
                        if (!poll) return;
                        if (poll.endTime && now > poll.endTime && !poll.isExpired) {
                            poll.isExpired = true;
                            pollHistory.push(poll);
                            allPolls = allPolls.filter(p => p.id !== poll.id);
                            savePollsToFirebase();
                            saveHistoryToFirebase();
                            if (currentPoll && currentPoll.id === poll.id) {
                                showResults();
                                if (voteBtn) voteBtn.disabled = true;
                            }
                        }
                    });
                    if (isAdmin && adminHistoryList) updateAdminPanel();
                }, 1000);
            }

            function updateAdminPanel() {
                if (!isAdmin || !adminPollsList || !adminHistoryList) return;

                adminPollsList.innerHTML = '';
                allPolls.forEach(poll => {
                    if (!poll) return;
                    const timeLeft = poll.endTime ? Math.max(0, poll.endTime - new Date().getTime()) : 0;
                    const card = document.createElement('div');
                    card.className = 'admin-poll-card';
                    card.innerHTML = `
                        <div><strong>Swali:</strong> ${poll.title}</div>
                        <div><strong>Kura:</strong> ${poll.totalVotes}</div>
                        <div><strong>Muda:</strong> ${poll.isExpired ? 'Imemalizika' : formatTimeRemaining(timeLeft)}</div>
                        <div><strong>Historia:</strong> ${poll.isExpired ? 'Hifadhi' : 'Inaendelea'}</div>
                        <button class="edit-btn" data-id="${poll.id}"><span class="icon">‚úèÔ∏è</span>Hariri</button>
                        <button class="delete-btn" data-id="${poll.id}"><span class="icon">üóëÔ∏è</span>Futa</button>
                    `;
                    adminPollsList.appendChild(card);
                });

                adminHistoryList.innerHTML = '';
                pollHistory.forEach(poll => {
                    if (!poll) return;
                    const card = document.createElement('div');
                    card.className = 'admin-poll-card';
                    let optionsHtml = '<div><strong>Chaguo:</strong></div><div class="options-list">';
                    poll.options.forEach(option => {
                        optionsHtml += `<div>${option.text}: ${option.votes} kura</div>`;
                    });
                    optionsHtml += '</div>';
                    card.innerHTML = `
                        <div><strong>Swali:</strong> ${poll.title}</div>
                        <div><strong>Jumla ya Kura:</strong> ${poll.totalVotes}</div>
                        ${optionsHtml}
                        <div><strong>Muda:</strong> Imemalizika</div>
                        <button class="delete-btn" data-id="${poll.id}"><span class="icon">üóëÔ∏è</span>Futa</button>
                    `;
                    adminHistoryList.appendChild(card);
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pollId = btn.dataset.id;
                        allPolls = allPolls.filter(p => p && p.id !== pollId);
                        pollHistory = pollHistory.filter(p => p && p.id !== pollId);
                        savePollsToFirebase();
                        saveHistoryToFirebase();
                        updateAdminPanel();
                        if (currentPoll && currentPoll.id === pollId) {
                            currentPoll = null;
                            if (activePollEl) activePollEl.style.display = 'none';
                        }
                    });
                });

                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pollId = btn.dataset.id;
                        const poll = allPolls.find(p => p.id === pollId);
                        if (poll && editPollForm) {
                            editPollForm.style.display = 'block';
                            if (createPollForm) createPollForm.style.display = 'none';
                            document.getElementById('edit-poll-title').value = poll.title;
                            document.getElementById('edit-poll-duration').value = poll.duration;
                            document.getElementById('edit-duration-unit').value = poll.durationUnit;
                            const editOptionsContainer = document.getElementById('edit-options-container');
                            if (editOptionsContainer) {
                                editOptionsContainer.innerHTML = '';
                                poll.options.forEach(option => {
                                    const optionDiv = document.createElement('div');
                                    optionDiv.className = 'option-input-container';
                                    optionDiv.innerHTML = `
                                        <input type="text" class="option-input" value="${option.text}">
                                        <button class="remove-option-btn">‚úï</button>
                                    `;
                                    editOptionsContainer.appendChild(optionDiv);
                                    optionDiv.querySelector('.remove-option-btn').addEventListener('click', function() {
                                        if (editOptionsContainer.children.length > 2) {
                                            editOptionsContainer.removeChild(optionDiv);
                                        }
                                    });
                                });
                            }
                            document.querySelector('.update-poll-btn').dataset.id = pollId;
                        }
                    });
                });
            }

            function showPasswordModal() {
                if (passwordModal) {
                    passwordModal.style.display = 'flex';
                    if (passwordInput) passwordInput.focus();
                }
            }

            function hidePasswordModal() {
                if (passwordModal) passwordModal.style.display = 'none';
            }

            function setupEventListeners() {
                if (voteBtn) voteBtn.addEventListener('click', submitVote);

                themeToggleBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        themeToggleBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        toggleTheme(this.dataset.theme);
                    });
                });

                if (createPollBtn) {
                    createPollBtn.addEventListener('click', () => {
                        showPasswordModal();
                    });
                }

                if (passwordSubmit) {
                    passwordSubmit.addEventListener('click', () => {
                        const password = passwordInput ? passwordInput.value : '';
                        if (password === CREATE_POLL_PASSWORD) {
                            isAdmin = true;
                            if (adminSection) adminSection.style.display = 'block';
                            if (activePollEl) activePollEl.style.display = 'none';
                            if (createPollForm) createPollForm.style.display = 'block';
                            if (editPollForm) editPollForm.style.display = 'none';
                            hidePasswordModal();
                            updateAdminPanel();
                        } else {
                            alert('Nenosiri sio sahihi! Tafadhali wasiliana na David Malosha Amos kwa namba 0785197452 au 0623715858 WhatsApp no yake ili upate nenosiri sahihi ili uweze kutengeneza na wewe maswali yako.');
                            if (passwordInput) passwordInput.value = '';
                        }
                    });
                }

                if (passwordInput) {
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && passwordSubmit) passwordSubmit.click();
                    });
                }

                if (backBtn) {
                    backBtn.addEventListener('click', () => {
                        isAdmin = false;
                        if (adminSection) adminSection.style.display = 'none';
                        if (createPollForm) createPollForm.style.display = 'none';
                        if (editPollForm) editPollForm.style.display = 'none';
                        if (activePollEl) activePollEl.style.display = 'block';
                    });
                }

                document.querySelectorAll('.add-option-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const optionsContainer = e.target.closest('.create-poll-form') ? 
                            document.getElementById('options-container') : 
                            document.getElementById('edit-options-container');
                        if (!optionsContainer) return;
                        const optionCount = optionsContainer.children.length + 1;
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'option-input-container';
                        optionDiv.innerHTML = `
                            <input type="text" class="option-input" placeholder="Chaguo ${optionCount}">
                            <button class="remove-option-btn">‚úï</button>
                        `;
                        optionsContainer.appendChild(optionDiv);
                        optionDiv.querySelector('.remove-option-btn').addEventListener('click', function() {
                            if (optionsContainer.children.length > 2) {
                                optionsContainer.removeChild(optionDiv);
                            }
                        });
                    });
                });

                document.querySelectorAll('.remove-option-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const optionsContainer = document.getElementById('options-container');
                        if (optionsContainer && optionsContainer.children.length > 2) {
                            optionsContainer.removeChild(this.parentElement);
                        }
                    });
                });

                const submitPollBtn = document.querySelector('.submit-poll-btn');
                if (submitPollBtn) {
                    submitPollBtn.addEventListener('click', () => {
                        const titleInput = document.getElementById('poll-title');
                        const optionInputs = document.querySelectorAll('#options-container .option-input');
                        const durationInput = document.getElementById('poll-duration');
                        const durationUnit = document.getElementById('duration-unit');

                        if (!titleInput || !titleInput.value.trim()) {
                            alert('Tafadhali jaza swali la kura!');
                            return;
                        }

                        let validOptions = [];
                        optionInputs.forEach(input => {
                            if (input.value.trim()) validOptions.push(input.value.trim());
                        });

                        if (validOptions.length < 2) {
                            alert('Tafadhali jaza angalau chaguo 2!');
                            return;
                        }

                        const duration = durationInput && durationInput.value ? parseInt(durationInput.value) : 5;
                        const durationUnitValue = durationUnit ? durationUnit.value : 'minutes';
                        const durationMultipliers = {
                            seconds: 1000,
                            minutes: 60000,
                            hours: 3600000,
                            weeks: 604800000,
                            months: 2592000000,
                            years: 31536000000
                        };
                        const endTime = new Date().getTime() + duration * durationMultipliers[durationUnitValue];

                        const newPoll = {
                            id: 'poll-' + Date.now(),
                            title: titleInput.value.trim(),
                            author: 'maloshadavid@92gmail.com',
                            date: new Date().toLocaleDateString('sw'),
                            options: validOptions.map((text, index) => ({
                                id: index + 1,
                                text: text,
                                votes: 0
                            })),
                            totalVotes: 0,
                            duration: duration,
                            durationUnit: durationUnitValue,
                            endTime: endTime,
                            isExpired: false
                        };

                        allPolls = [newPoll];
                        currentPoll = newPoll;
                        savePollsToFirebase();
                        renderPoll();
                        updateAdminPanel();

                        if (titleInput) titleInput.value = '';
                        if (durationInput) durationInput.value = '';
                        const optionsContainer = document.getElementById('options-container');
                        if (optionsContainer) {
                            optionsContainer.innerHTML = `
                                <div class="option-input-container">
                                    <input type="text" class="option-input" placeholder="Chaguo 1">
                                    <button class="remove-option-btn">‚úï</button>
                                </div>
                                <div class="option-input-container">
                                    <input type="text" class="option-input" placeholder="Chaguo 2">
                                    <button class="remove-option-btn">‚úï</button>
                                </div>
                            `;
                            optionsContainer.querySelectorAll('.remove-option-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    if (optionsContainer.children.length > 2) {
                                        optionsContainer.removeChild(this.parentElement);
                                    }
                                });
                            });
                        }

                        if (activePollEl) activePollEl.style.display = 'block';
                        if (createPollForm) createPollForm.style.display = 'none';
                    });
                }

                const updatePollBtn = document.querySelector('.update-poll-btn');
                if (updatePollBtn) {
                    updatePollBtn.addEventListener('click', () => {
                        const pollId = updatePollBtn.dataset.id;
                        const titleInput = document.getElementById('edit-poll-title');
                        const durationInput = document.getElementById('edit-poll-duration');
                        const durationUnit = document.getElementById('edit-duration-unit');
                        const optionInputs = document.querySelectorAll('#edit-options-container .option-input');

                        if (!titleInput || !titleInput.value.trim()) {
                            alert('Tafadhali jaza swali la kura!');
                            return;
                        }

                        let validOptions = [];
                        optionInputs.forEach(input => {
                            if (input.value.trim()) validOptions.push(input.value.trim());
                        });

                        if (validOptions.length < 2) {
                            alert('Tafadhali jaza angalau chaguo 2!');
                            return;
                        }

                        const duration = durationInput && durationInput.value ? parseInt(durationInput.value) : 5;
                        const durationUnitValue = durationUnit ? durationUnit.value : 'minutes';
                        const durationMultipliers = {
                            seconds: 1000,
                            minutes: 60000,
                            hours: 3600000,
                            weeks: 604800000,
                            months: 2592000000,
                            years: 31536000000
                        };
                        const endTime = new Date().getTime() + duration * durationMultipliers[durationUnitValue];

                        const pollIndex = allPolls.findIndex(p => p.id === pollId);
                        if (pollIndex !== -1) {
                            allPolls[pollIndex].title = titleInput.value.trim();
                            allPolls[pollIndex].duration = duration;
                            allPolls[pollIndex].durationUnit = durationUnitValue;
                            allPolls[pollIndex].endTime = endTime;
                            allPolls[pollIndex].options = validOptions.map((text, index) => ({
                                id: index + 1,
                                text: text,
                                votes: allPolls[pollIndex].options[index] ? allPolls[pollIndex].options[index].votes : 0
                            }));
                            currentPoll = allPolls[pollIndex];
                            savePollsToFirebase();
                            renderPoll();
                            updateAdminPanel();
                            if (editPollForm) editPollForm.style.display = 'none';
                            if (activePollEl) activePollEl.style.display = 'block';
                        }
                    });
                }

                lightModeBtn.addEventListener('click', () => {
                    document.body.classList.remove('dark-mode');
                });

                darkModeBtn.addEventListener('click', () => {
                    document.body.classList.add('dark-mode');
                });
            }

            init();
        });
    </script>
</body>
</html>

      
                        